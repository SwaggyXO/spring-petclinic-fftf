<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org" th:replace="~{fragments/layout :: layout (~{::body},'home')}">
<head>
  <meta charset="UTF-8">
  <title>Feature Flag Dashboard</title>
  <style>
    .flag-card {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      background: #fff;
    }
    .flag-enabled { border-left: 4px solid #28a745; }
    .flag-disabled { border-left: 4px solid #dc3545; }
    .strategy-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
    }
    .audit-log {
      font-size: 12px;
    }
    .modal-dialog { max-width: 600px; }

    /* Badge styles with proper colors */
    .badge-success {
      background-color: #5cb85c !important;
      color: white !important;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
    }
    .badge-danger {
      background-color: #d9534f !important;
      color: white !important;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
    }

    /* Outline button styles */
    .btn-outline-primary {
      color: #337ab7;
      background-color: transparent;
      border-color: #337ab7;
    }
    .btn-outline-primary:hover {
      color: #fff;
      background-color: #337ab7;
      border-color: #337ab7;
    }
    .btn-outline-info {
      color: #5bc0de;
      background-color: transparent;
      border-color: #5bc0de;
    }
    .btn-outline-info:hover {
      color: #fff;
      background-color: #5bc0de;
      border-color: #5bc0de;
    }
    .btn-outline-warning {
      color: #f0ad4e;
      background-color: transparent;
      border-color: #f0ad4e;
    }
    .btn-outline-warning:hover {
      color: #fff;
      background-color: #f0ad4e;
      border-color: #f0ad4e;
    }
    .btn-outline-danger {
      color: #d9534f;
      background-color: transparent;
      border-color: #d9534f;
    }
    .btn-outline-danger:hover {
      color: #fff;
      background-color: #d9534f;
      border-color: #d9534f;
    }

    /* Pagination styles */
    .pagination {
      display: inline-block;
      padding-left: 0;
      margin: 20px 0;
      border-radius: 4px;
    }
    .pagination > li {
      display: inline;
    }
    .pagination > li > a,
    .pagination > li > span {
      position: relative;
      float: left;
      padding: 6px 12px;
      margin-left: -1px;
      line-height: 1.42857143;
      color: #337ab7;
      text-decoration: none;
      background-color: #fff;
      border: 1px solid #ddd;
    }
    .pagination > li:first-child > a,
    .pagination > li:first-child > span {
      margin-left: 0;
      border-top-left-radius: 4px;
      border-bottom-left-radius: 4px;
    }
    .pagination > li:last-child > a,
    .pagination > li:last-child > span {
      border-top-right-radius: 4px;
      border-bottom-right-radius: 4px;
    }
    .pagination > li > a:hover,
    .pagination > li > span:hover {
      z-index: 2;
      color: #23527c;
      background-color: #eee;
      border-color: #ddd;
    }
    .pagination > .active > a,
    .pagination > .active > span {
      z-index: 3;
      color: #fff;
      cursor: default;
      background-color: #337ab7;
      border-color: #337ab7;
    }
    .pagination > .disabled > span,
    .pagination > .disabled > a {
      color: #777;
      cursor: not-allowed;
      background-color: #fff;
      border-color: #ddd;
    }
  </style>
</head>
<body>
<div class="container">
  <div class="row">
    <div class="col-md-12">
      <!-- Error alert -->
      <div th:if="${error}" class="alert alert-danger alert-dismissible" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <strong>Error:</strong> <span th:text="${error}"></span>
      </div>

      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2>Feature Flag Dashboard</h2>
        <div>
          <span>Welcome, <strong th:text="${username}">Admin</strong></span> |
          <a th:href="@{/admin/logout}" class="btn btn-sm btn-danger">Logout</a>
        </div>
      </div>

      <button class="btn btn-success btn-lg" onclick="showCreateModal()">
        <span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Create New Flag
      </button>

      <hr/>

      <h3>Active Feature Flags</h3>
      <div id="flagsContainer">
        <div th:each="flag : ${flags}"
             th:class="${flag.enabled} ? 'flag-card flag-enabled' : 'flag-card flag-disabled'">
          <div style="display: flex; justify-content: space-between; align-items: start;">
            <div style="flex: 1;">
              <h4 style="margin-top: 0;">
                <code th:text="${flag.flagKey}">flag_key</code>
                <span th:class="'badge ' + (${flag.enabled} ? 'badge-success' : 'badge-danger')"
                      th:text="${flag.enabled} ? 'ENABLED' : 'DISABLED'">Status</span>
              </h4>
              <p th:text="${flag.description}">Description</p>
              <div>
                <span class="strategy-badge" style="background: #e3f2fd; color: #1976d2;"
                      th:text="${flag.strategyType}">BOOLEAN</span>
                <span class="text-muted" style="margin-left: 10px;">
                  Environment: <strong th:text="${flag.environment}">development</strong>
                </span>
              </div>
            </div>
            <div style="white-space: nowrap;">
              <button class="btn btn-sm btn-outline-primary"
                      th:attr="data-flag-key=${flag.flagKey}"
                      onclick="showToggleConfirm(this.getAttribute('data-flag-key'))"
                      title="Toggle flag on/off"
                      style="min-width: 80px; margin-right: 5px;">
                <span class="glyphicon glyphicon-refresh"></span> Toggle
              </button>
              <button class="btn btn-sm btn-outline-info"
                      th:attr="data-flag-key=${flag.flagKey}"
                      onclick="viewFlagModal(this.getAttribute('data-flag-key'))"
                      title="View flag details"
                      style="min-width: 80px; margin-right: 5px;">
                <span class="glyphicon glyphicon-eye-open"></span> View
              </button>
              <button class="btn btn-sm btn-outline-warning"
                      th:attr="data-flag-key=${flag.flagKey}"
                      onclick="editFlag(this.getAttribute('data-flag-key'))"
                      title="Edit flag"
                      style="min-width: 80px; margin-right: 5px;">
                <span class="glyphicon glyphicon-edit"></span> Edit
              </button>
              <button class="btn btn-sm btn-outline-danger"
                      th:attr="data-flag-key=${flag.flagKey}"
                      onclick="showDeleteConfirm(this.getAttribute('data-flag-key'))"
                      title="Delete flag"
                      style="min-width: 80px;">
                <span class="glyphicon glyphicon-trash"></span> Delete
              </button>
            </div>
          </div>
        </div>
      </div>

      <hr/>

      <h3>Recent Audit Log</h3>

      <!-- Page Size Selector -->
      <div style="margin-bottom: 15px;">
        <label for="auditPageSize">Show: </label>
        <select id="auditPageSize" class="form-control" style="width: auto; display: inline-block;" onchange="changeAuditPageSize()">
          <option value="5" th:selected="${auditPage.size == 5}">5 per page</option>
          <option value="10" th:selected="${auditPage.size == 10}">10 per page</option>
          <option value="20" th:selected="${auditPage.size == 20}">20 per page</option>
          <option value="50" th:selected="${auditPage.size == 50}">50 per page</option>
        </select>
        <span class="text-muted" style="margin-left: 15px;">
          Showing <strong th:text="${auditPage.numberOfElements}">10</strong> of
          <strong th:text="${auditPage.totalElements}">45</strong> entries
        </span>
      </div>

      <div class="audit-log">
        <table class="table table-striped table-condensed">
          <thead>
          <tr>
            <th>Timestamp</th>
            <th>Flag Key</th>
            <th>Action</th>
            <th>Changed By</th>
            <th>Reason</th>
          </tr>
          </thead>
          <tbody>
          <tr th:if="${auditPage.totalElements == 0}">
            <td colspan="5" class="text-center text-muted">No audit entries found</td>
          </tr>
          <tr th:each="audit : ${recentAudits}">
            <td th:text="${#temporals.format(audit.timestamp, 'yyyy-MM-dd HH:mm:ss')}">2024-01-01 12:00:00</td>
            <td><code th:text="${audit.flagKey}">flag_key</code></td>
            <td>
              <span class="label label-info" th:text="${audit.action}">CREATE</span>
            </td>
            <td th:text="${audit.changedBy}">admin</td>
            <td th:text="${audit.reason}">Initial creation</td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination Controls -->
      <div th:if="${auditPage.totalPages > 1}" class="text-center" style="margin-top: 20px;">
        <nav>
          <ul class="pagination">
            <!-- First Page -->
            <li th:class="${auditPage.first} ? 'disabled' : ''">
              <a th:if="${!auditPage.first}"
                 th:href="@{/admin/flags(auditPage=0, auditSize=${auditPage.size})}"
                 aria-label="First">
                <span aria-hidden="true">&laquo;&laquo;</span>
              </a>
              <span th:if="${auditPage.first}" aria-hidden="true">&laquo;&laquo;</span>
            </li>

            <!-- Previous Page -->
            <li th:class="${auditPage.first} ? 'disabled' : ''">
              <a th:if="${!auditPage.first}"
                 th:href="@{/admin/flags(auditPage=${auditPage.number - 1}, auditSize=${auditPage.size})}"
                 aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
              <span th:if="${auditPage.first}" aria-hidden="true">&laquo;</span>
            </li>

            <!-- Page Numbers -->
            <li th:each="pageNum : ${#numbers.sequence(0, auditPage.totalPages - 1)}"
                th:if="${pageNum >= auditPage.number - 2 && pageNum <= auditPage.number + 2}"
                th:class="${pageNum == auditPage.number} ? 'active' : ''">
              <a th:if="${pageNum != auditPage.number}"
                 th:href="@{/admin/flags(auditPage=${pageNum}, auditSize=${auditPage.size})}"
                 th:text="${pageNum + 1}">1</a>
              <span th:if="${pageNum == auditPage.number}" th:text="${pageNum + 1}">1</span>
            </li>

            <!-- Next Page -->
            <li th:class="${auditPage.last} ? 'disabled' : ''">
              <a th:if="${!auditPage.last}"
                 th:href="@{/admin/flags(auditPage=${auditPage.number + 1}, auditSize=${auditPage.size})}"
                 aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
              <span th:if="${auditPage.last}" aria-hidden="true">&raquo;</span>
            </li>

            <!-- Last Page -->
            <li th:class="${auditPage.last} ? 'disabled' : ''">
              <a th:if="${!auditPage.last}"
                 th:href="@{/admin/flags(auditPage=${auditPage.totalPages - 1}, auditSize=${auditPage.size})}"
                 aria-label="Last">
                <span aria-hidden="true">&raquo;&raquo;</span>
              </a>
              <span th:if="${auditPage.last}" aria-hidden="true">&raquo;&raquo;</span>
            </li>
          </ul>
        </nav>

        <!-- Page Info -->
        <p class="text-muted" style="font-size: 12px;">
          Page <strong th:text="${auditPage.number + 1}">1</strong> of
          <strong th:text="${auditPage.totalPages}">5</strong>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal" id="flagModal" tabindex="-1" role="dialog" style="display: none; position: fixed; z-index: 1050; top: 0; left: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-dialog" role="document" style="position: relative; width: 600px; margin: 50px auto; background-color: white; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; border: 1px solid #ddd; border-radius: 6px;">
      <div class="modal-header" style="padding: 15px; border-bottom: 1px solid #e5e5e5;">
        <button type="button" class="close" onclick="hideModal()" style="float: right; font-size: 21px; font-weight: bold; line-height: 1; color: #000; opacity: 0.2; background: transparent; border: 0; cursor: pointer;">&times;</button>
        <h4 class="modal-title" id="modalTitle" style="margin: 0; line-height: 1.42857143;">Create Feature Flag</h4>
      </div>
      <div class="modal-body" style="position: relative; padding: 15px;">
        <form id="flagForm">
          <!-- Flag Key - Only visible in CREATE mode -->
          <div class="form-group" id="flagKeyGroup">
            <label for="flagKey">Flag Key *</label>
            <input type="text" class="form-control" id="flagKey"
                   placeholder="e.g., new_checkout_flow" pattern="[a-z0-9_]+" required>
            <small class="text-muted">Only lowercase letters, numbers, and underscores</small>
          </div>

          <!-- Flag Key Display - Only visible in EDIT mode -->
          <div class="form-group" id="flagKeyDisplay" style="display: none;">
            <label>Flag Key</label>
            <div class="well well-sm" style="background: #f5f5f5; padding: 10px; margin-bottom: 0;">
              <code id="flagKeyReadonly" style="font-size: 14px;"></code>
            </div>
            <small class="text-muted">Flag key cannot be changed after creation</small>
          </div>

          <!-- Description - Editable in both modes -->
          <div class="form-group">
            <label for="description">Description</label>
            <textarea class="form-control" id="description" rows="2"
                      placeholder="What does this flag control?"></textarea>
          </div>

          <!-- Environment - Only visible in CREATE mode -->
          <div class="form-group" id="environmentGroup">
            <label for="environment">Environment *</label>
            <select class="form-control" id="environment" required>
              <option value="development">Development</option>
              <option value="staging">Staging</option>
              <option value="production">Production</option>
            </select>
          </div>

          <!-- Environment Display - Only visible in EDIT mode -->
          <div class="form-group" id="environmentDisplay" style="display: none;">
            <label>Environment</label>
            <div class="well well-sm" style="background: #f5f5f5; padding: 10px; margin-bottom: 0;">
              <span id="environmentReadonly" class="badge"></span>
            </div>
            <small class="text-muted">Environment cannot be changed after creation</small>
          </div>

          <!-- Enabled - Only visible in CREATE mode -->
          <div class="form-group" id="enabledGroup">
            <label>
              <input type="checkbox" id="enabled"> Enabled
            </label>
            <small class="text-muted" style="display: block;">Use Toggle button to enable/disable after creation</small>
          </div>

          <!-- Strategy Type - Editable in both modes -->
          <div class="form-group">
            <label for="strategyType">Strategy Type *</label>
            <select class="form-control" id="strategyType" onchange="updateStrategyConfig()">
              <option value="BOOLEAN">Boolean (Simple On/Off)</option>
              <option value="PERCENTAGE">Percentage Rollout</option>
              <option value="WHITELIST">Whitelist (Allow Specific)</option>
              <option value="BLACKLIST">Blacklist (Block Specific)</option>
              <option value="USER_ATTRIBUTE">User Attribute</option>
              <option value="KILL_SWITCH">Kill Switch (Always Off)</option>
            </select>
          </div>

          <!-- Strategy Config - Editable in both modes -->
          <div id="strategyConfigDiv" style="display: none;">
            <div class="form-group">
              <label>Strategy Configuration</label>
              <div id="percentageConfig" style="display: none;">
                <label for="percentage">Percentage (0-100)</label>
                <input type="number" class="form-control" id="percentage" min="0" max="100" value="50">
              </div>
              <div id="whitelistConfig" style="display: none;">
                <label for="whitelist">Whitelist (comma-separated user IDs or IPs)</label>
                <input type="text" class="form-control" id="whitelist" placeholder="user123, 192.168.1.100">
              </div>
              <div id="blacklistConfig" style="display: none;">
                <label for="blacklist">Blacklist (comma-separated user IDs or IPs)</label>
                <input type="text" class="form-control" id="blacklist" placeholder="baduser, 10.0.0.1">
              </div>
            </div>
          </div>

          <!-- Reason - Always visible -->
          <div class="form-group">
            <label for="reason">Reason for Change <span id="reasonRequired" style="display: none; color: red;">*</span></label>
            <input type="text" class="form-control" id="reason" placeholder="Why are you creating/updating this flag?">
          </div>
        </form>
      </div>
      <div class="modal-footer" style="padding: 15px; text-align: right; border-top: 1px solid #e5e5e5;">
        <button type="button" class="btn btn-default" onclick="hideModal()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveFlag()">
          <span id="saveButtonText">Save</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Flag Modal -->
<div class="modal" id="viewFlagModal" tabindex="-1" role="dialog" style="display: none; position: fixed; z-index: 1050; top: 0; left: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-dialog" role="document" style="position: relative; width: 600px; margin: 50px auto; background-color: white; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; border: 1px solid #ddd; border-radius: 6px;">
      <div class="modal-header" style="padding: 15px; border-bottom: 1px solid #e5e5e5;">
        <button type="button" class="close" onclick="hideViewModal()" style="float: right; font-size: 21px; font-weight: bold; line-height: 1; color: #000; opacity: 0.2; background: transparent; border: 0; cursor: pointer;">&times;</button>
        <h4 class="modal-title" style="margin: 0; line-height: 1.42857143;">Flag Details</h4>
      </div>
      <div class="modal-body" style="position: relative; padding: 15px;">
        <table class="table table-bordered">
          <tbody>
          <tr>
            <th style="width: 30%;">Flag Key</th>
            <td><code id="view-flagKey"></code></td>
          </tr>
          <tr>
            <th>Description</th>
            <td id="view-description"></td>
          </tr>
          <tr>
            <th>Status</th>
            <td id="view-enabled"></td>
          </tr>
          <tr>
            <th>Strategy Type</th>
            <td id="view-strategyType"></td>
          </tr>
          <tr>
            <th>Strategy Config</th>
            <td><pre id="view-strategyConfig" style="margin: 0; background: #f5f5f5; padding: 10px; border-radius: 4px;"></pre></td>
          </tr>
          <tr>
            <th>Environment</th>
            <td id="view-environment"></td>
          </tr>
          <tr>
            <th>Created At</th>
            <td id="view-createdAt"></td>
          </tr>
          <tr>
            <th>Created By</th>
            <td id="view-createdBy"></td>
          </tr>
          <tr>
            <th>Updated At</th>
            <td id="view-updatedAt"></td>
          </tr>
          <tr>
            <th>Updated By</th>
            <td id="view-updatedBy"></td>
          </tr>
          </tbody>
        </table>
      </div>
      <div class="modal-footer" style="padding: 15px; text-align: right; border-top: 1px solid #e5e5e5;">
        <button type="button" class="btn btn-default" onclick="hideViewModal()">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Toggle Confirmation Modal -->
<div class="modal" id="toggleConfirmModal" tabindex="-1" role="dialog" style="display: none; position: fixed; z-index: 1050; top: 0; left: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-dialog" role="document" style="position: relative; width: 450px; margin: 100px auto; background-color: white; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; border: 1px solid #ddd; border-radius: 6px;">
      <div class="modal-header" style="padding: 15px; border-bottom: 1px solid #e5e5e5;">
        <button type="button" class="close" onclick="hideToggleConfirm()" style="float: right; font-size: 21px; font-weight: bold; line-height: 1; color: #000; opacity: 0.2; background: transparent; border: 0; cursor: pointer;">&times;</button>
        <h4 class="modal-title" style="margin: 0; line-height: 1.42857143;">
          <span class="glyphicon glyphicon-question-sign" style="color: #5bc0de;"></span> Confirm Toggle
        </h4>
      </div>
      <div class="modal-body" style="position: relative; padding: 20px;">
        <p>Are you sure you want to toggle flag <strong><code id="toggle-flag-name"></code></strong>?</p>
        <p class="text-muted" style="font-size: 12px;">This will change its enabled/disabled state immediately.</p>
      </div>
      <div class="modal-footer" style="padding: 15px; text-align: right; border-top: 1px solid #e5e5e5;">
        <button type="button" class="btn btn-default" onclick="hideToggleConfirm()">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="confirmToggle()">
          <span class="glyphicon glyphicon-refresh"></span> Toggle
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal" id="deleteConfirmModal" tabindex="-1" role="dialog" style="display: none; position: fixed; z-index: 1050; top: 0; left: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
  <div class="modal-dialog" role="document" style="position: relative; width: 450px; margin: 100px auto; background-color: white; border-radius: 6px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; border: 1px solid #ddd; border-radius: 6px;">
      <div class="modal-header" style="padding: 15px; border-bottom: 1px solid #e5e5e5;">
        <button type="button" class="close" onclick="hideDeleteConfirm()" style="float: right; font-size: 21px; font-weight: bold; line-height: 1; color: #000; opacity: 0.2; background: transparent; border: 0; cursor: pointer;">&times;</button>
        <h4 class="modal-title" style="margin: 0; line-height: 1.42857143;">
          <span class="glyphicon glyphicon-warning-sign" style="color: #d9534f;"></span> Confirm Delete
        </h4>
      </div>
      <div class="modal-body" style="position: relative; padding: 20px;">
        <p>Are you sure you want to delete flag <strong><code id="delete-flag-name"></code></strong>?</p>
        <p class="text-danger" style="font-size: 12px;"><strong>Warning:</strong> This action cannot be undone.</p>
      </div>
      <div class="modal-footer" style="padding: 15px; text-align: right; border-top: 1px solid #e5e5e5;">
        <button type="button" class="btn btn-default" onclick="hideDeleteConfirm()">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmDelete()">
          <span class="glyphicon glyphicon-trash"></span> Delete
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  let editMode = false;
  let currentFlagKey = null;
  let currentFlagData = null;
  let toggleFlagKey = null;
  let deleteFlagKey = null;

  function showCreateModal() {
    editMode = false;
    currentFlagKey = null;
    currentFlagData = null;

    document.getElementById('flagForm').reset();
    document.getElementById('flagKeyGroup').style.display = 'block';
    document.getElementById('flagKeyDisplay').style.display = 'none';
    document.getElementById('environmentGroup').style.display = 'block';
    document.getElementById('environmentDisplay').style.display = 'none';
    document.getElementById('enabledGroup').style.display = 'block';
    document.getElementById('reasonRequired').style.display = 'none';
    document.getElementById('flagKey').disabled = false;
    document.getElementById('modalTitle').textContent = 'Create Feature Flag';
    document.getElementById('saveButtonText').textContent = 'Create';

    updateStrategyConfig();
    document.getElementById('flagModal').style.display = 'block';
  }

  function hideModal() {
    document.getElementById('flagModal').style.display = 'none';
  }

  function hideViewModal() {
    document.getElementById('viewFlagModal').style.display = 'none';
  }

  function showToggleConfirm(flagKey) {
    toggleFlagKey = flagKey;
    document.getElementById('toggle-flag-name').textContent = flagKey;
    document.getElementById('toggleConfirmModal').style.display = 'block';
  }

  function hideToggleConfirm() {
    document.getElementById('toggleConfirmModal').style.display = 'none';
    toggleFlagKey = null;
  }

  function confirmToggle() {
    if (toggleFlagKey) {
      fetch('/api/v1/flags/' + toggleFlagKey + '/toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      })
        .then(response => response.json())
        .then(() => {
          hideToggleConfirm();
          location.reload();
        })
        .catch(error => {
          alert('Error: ' + error.message);
          hideToggleConfirm();
        });
    }
  }

  function showDeleteConfirm(flagKey) {
    deleteFlagKey = flagKey;
    document.getElementById('delete-flag-name').textContent = flagKey;
    document.getElementById('deleteConfirmModal').style.display = 'block';
  }

  function hideDeleteConfirm() {
    document.getElementById('deleteConfirmModal').style.display = 'none';
    deleteFlagKey = null;
  }

  function confirmDelete() {
    if (deleteFlagKey) {
      fetch('/api/v1/flags/' + deleteFlagKey, { method: 'DELETE' })
        .then(() => {
          hideDeleteConfirm();
          location.reload();
        })
        .catch(error => {
          alert('Error: ' + error.message);
          hideDeleteConfirm();
        });
    }
  }

  function viewFlagModal(flagKey) {
    fetch('/api/v1/flags/' + flagKey)
      .then(response => response.json())
      .then(data => {
        document.getElementById('view-flagKey').textContent = data.flagKey;
        document.getElementById('view-description').textContent = data.description || 'N/A';
        document.getElementById('view-enabled').innerHTML = data.enabled
          ? '<span class="badge badge-success">ENABLED</span>'
          : '<span class="badge badge-danger">DISABLED</span>';
        document.getElementById('view-strategyType').textContent = data.strategyType;
        if (data.strategyConfig && Object.keys(data.strategyConfig).length > 0) {
          document.getElementById('view-strategyConfig').textContent =
            JSON.stringify(data.strategyConfig, null, 2);
        } else {
          document.getElementById('view-strategyConfig').textContent = '{}';
        }
        document.getElementById('view-environment').textContent = data.environment;
        document.getElementById('view-createdAt').textContent = formatDate(data.createdAt);
        document.getElementById('view-createdBy').textContent = data.createdBy || 'N/A';
        document.getElementById('view-updatedAt').textContent = formatDate(data.updatedAt);
        document.getElementById('view-updatedBy').textContent = data.updatedBy || 'N/A';
        document.getElementById('viewFlagModal').style.display = 'block';
      })
      .catch(error => {
        alert('Error fetching flag details: ' + error.message);
      });
  }

  function formatDate(dateString) {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString('en-IN', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }

  function updateStrategyConfig() {
    const strategyType = document.getElementById('strategyType').value;
    const configDiv = document.getElementById('strategyConfigDiv');
    document.getElementById('percentageConfig').style.display = 'none';
    document.getElementById('whitelistConfig').style.display = 'none';
    document.getElementById('blacklistConfig').style.display = 'none';

    if (strategyType === 'PERCENTAGE') {
      configDiv.style.display = 'block';
      document.getElementById('percentageConfig').style.display = 'block';
    } else if (strategyType === 'WHITELIST') {
      configDiv.style.display = 'block';
      document.getElementById('whitelistConfig').style.display = 'block';
    } else if (strategyType === 'BLACKLIST') {
      configDiv.style.display = 'block';
      document.getElementById('blacklistConfig').style.display = 'block';
    } else {
      configDiv.style.display = 'none';
    }
  }

  function saveFlag() {
    const reason = document.getElementById('reason').value;

    if (editMode && !reason) {
      alert('Reason for change is required when updating a flag');
      return;
    }

    if (editMode) {
      // UPDATE MODE - Send complete payload with all fields from currentFlagData
      const strategyType = document.getElementById('strategyType').value;

      if (!strategyType || strategyType === '') {
        alert('Strategy Type is required');
        return;
      }

      let strategyConfig = {};
      if (strategyType === 'PERCENTAGE') {
        strategyConfig = { percentage: parseInt(document.getElementById('percentage').value) };
      } else if (strategyType === 'WHITELIST') {
        const whitelistValue = document.getElementById('whitelist').value.trim();
        strategyConfig = whitelistValue ?
          { whitelist: whitelistValue.split(',').map(s => s.trim()).filter(s => s.length > 0) } :
          { whitelist: [] };
      } else if (strategyType === 'BLACKLIST') {
        const blacklistValue = document.getElementById('blacklist').value.trim();
        strategyConfig = blacklistValue ?
          { blacklist: blacklistValue.split(',').map(s => s.trim()).filter(s => s.length > 0) } :
          { blacklist: [] };
      }

      // THE FIX: Send ALL fields that backend DTO expects
      const payload = {
        flagKey: currentFlagData.flagKey,           // Required by DTO
        description: document.getElementById('description').value,
        enabled: currentFlagData.enabled,           // Keep existing
        strategyType: strategyType,
        strategyConfig: strategyConfig,
        environment: currentFlagData.environment,   // Keep existing
        createdBy: currentFlagData.createdBy || 'admin',  // Required by DTO
        updatedBy: 'admin',
        reason: reason
      };

      console.log('UPDATE Payload:', JSON.stringify(payload, null, 2));

      fetch(`/api/v1/flags/${currentFlagKey}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => { throw err; });
          }
          return response.json();
        })
        .then(data => {
          hideModal();
          location.reload();
        })
        .catch(error => {
          console.error('Update error:', error);
          alert('Error: ' + (error.message || JSON.stringify(error)));
        });

    } else {
      // CREATE MODE
      const flagKey = document.getElementById('flagKey').value;
      const description = document.getElementById('description').value;
      const enabled = document.getElementById('enabled').checked;
      const strategyType = document.getElementById('strategyType').value;
      const environment = document.getElementById('environment').value;

      if (!strategyType || strategyType === '') {
        alert('Strategy Type is required');
        return;
      }

      let strategyConfig = {};
      if (strategyType === 'PERCENTAGE') {
        strategyConfig = { percentage: parseInt(document.getElementById('percentage').value) };
      } else if (strategyType === 'WHITELIST') {
        strategyConfig = { whitelist: document.getElementById('whitelist').value.split(',').map(s => s.trim()).filter(s => s.length > 0) };
      } else if (strategyType === 'BLACKLIST') {
        strategyConfig = { blacklist: document.getElementById('blacklist').value.split(',').map(s => s.trim()).filter(s => s.length > 0) };
      }

      const payload = {
        flagKey: flagKey,
        description: description,
        enabled: enabled,
        strategyType: strategyType,
        strategyConfig: strategyConfig,
        environment: environment,
        createdBy: 'admin',
        reason: reason || 'No reason provided'
      };

      console.log('CREATE Payload:', JSON.stringify(payload, null, 2));

      fetch('/api/v1/flags', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(err => { throw err; });
          }
          return response.json();
        })
        .then(data => {
          hideModal();
          location.reload();
        })
        .catch(error => {
          console.error('Create error:', error);
          alert('Error: ' + (error.message || JSON.stringify(error)));
        });
    }
  }

  function editFlag(flagKey) {
    editMode = true;
    currentFlagKey = flagKey;

    fetch('/api/v1/flags/' + flagKey)
      .then(response => response.json())
      .then(data => {
        currentFlagData = data;
        document.getElementById('flagForm').reset();
        document.getElementById('flagKeyGroup').style.display = 'none';
        document.getElementById('environmentGroup').style.display = 'none';
        document.getElementById('enabledGroup').style.display = 'none';
        document.getElementById('flagKeyDisplay').style.display = 'block';
        document.getElementById('flagKeyReadonly').textContent = data.flagKey;
        document.getElementById('environmentDisplay').style.display = 'block';

        const envBadge = document.getElementById('environmentReadonly');
        envBadge.textContent = data.environment;
        if (data.environment === 'production') {
          envBadge.style.backgroundColor = '#d9534f';
          envBadge.style.color = 'white';
        } else if (data.environment === 'staging') {
          envBadge.style.backgroundColor = '#f0ad4e';
          envBadge.style.color = 'white';
        } else {
          envBadge.style.backgroundColor = '#5bc0de';
          envBadge.style.color = 'white';
        }

        document.getElementById('reasonRequired').style.display = 'inline';
        document.getElementById('description').value = data.description || '';
        document.getElementById('strategyType').value = data.strategyType;
        updateStrategyConfig();

        if (data.strategyConfig) {
          if (data.strategyConfig.percentage !== undefined) {
            document.getElementById('percentage').value = data.strategyConfig.percentage;
          }
          if (data.strategyConfig.whitelist) {
            document.getElementById('whitelist').value = data.strategyConfig.whitelist.join(', ');
          }
          if (data.strategyConfig.blacklist) {
            document.getElementById('blacklist').value = data.strategyConfig.blacklist.join(', ');
          }
        }

        document.getElementById('modalTitle').textContent = 'Update Feature Flag';
        document.getElementById('saveButtonText').textContent = 'Update';
        document.getElementById('flagModal').style.display = 'block';
      })
      .catch(error => alert('Error: ' + error.message));
  }

  function changeAuditPageSize() {
    const pageSize = document.getElementById('auditPageSize').value;
    window.location.href = '/admin/flags?auditPage=0&auditSize=' + pageSize;
  }

  document.addEventListener('click', function(e) {
    if (e.target.id === 'flagModal') hideModal();
    if (e.target.id === 'viewFlagModal') hideViewModal();
    if (e.target.id === 'toggleConfirmModal') hideToggleConfirm();
    if (e.target.id === 'deleteConfirmModal') hideDeleteConfirm();
  });
</script>
</body>
</html>
